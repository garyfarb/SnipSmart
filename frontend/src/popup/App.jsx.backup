import { useState, useEffect } from 'react'
import { cropImage, preprocessImage }  from "../utils/imageUtils"
import runOCR from "../utils/ocrUtils"

function App() {
  const [status, setStatus] = useState("Idle")
  const [image, setImage] = useState(null)
  const [ocrText, setOcrText] = useState("")

  const handleClick = () => {
    setStatus("Snip Mode!")
    chrome.runtime.sendMessage({ action: "START_SNIP"}) 
  }

  useEffect(() => {
    const handleProcessedSnip = async (snip) => {
      try {
        setStatus("Cropping...")
        const cropped = await cropImage(snip.screenshot, snip.rect)
        const processed = await preprocessImage(cropped)

        setImage(processed)
        setStatus("Running OCR...")

        const text = await runOCR(processed, "eng")
        setOcrText(text)
        setStatus("OCR Complete!")
      } catch (err) {
        console.error("Failed to process snip:", err)
        setStatus("OCR Error")
      }
    }

    chrome.storage.local.get("lastSnip", ({ lastSnip }) => {
      if (lastSnip) {
        handleProcessedSnip(lastSnip)
      }
    })

    const handleStorageChange = (changes) => {
      if (changes.lastSnip?.newValue) {
        handleProcessedSnip(changes.lastSnip.newValue)
      }
    }

    chrome.storage.onChanged.addListener(handleStorageChange)
    return () => chrome.storage.onChanged.removeListener(handleStorageChange)
  }, [])

  /* 
    Add the button html tag
    Give it a new function instead of handleClick
    Copy and paste file into chatgpt and ask it to explain how to add functionality to a button, 
    SetStatus and set to idle, 
    Send message to chrome to exit snip mode
    Use the listener in service-worker.js to listen for the message and exit snip mode
    Create new function and use execute script to run it in the content script
    The function should remove the overlay element
    Can use get element by id to find the overlay element and remove it
  */

  document.getElementById("exitSnipBtn").addEventListener("click", exitSnipMode);

  function exitSnipMode() 
  {
    console.log("Exit Snip button clicked");
    setStatus("idle");
  
    chrome.runtime.sendMessage({ action: "exitSnipMode" });
  }


  return (
    <>
      <div style={{ padding: "10px", width: "150px"}}>
        <button onClick={handleClick}>Start Snip</button>
        <p>{status}</p>
      </div>

      {image && (
        <div>
          <h4>Preview:</h4>
          <img src={image} alt="snip" style={{ maxWidth: "200px" }} />
        </div>
      )}

      {ocrText && (
        <div>
          <h4>Detected Text:</h4>
          <pre>{ocrText}</pre>
        </div>
      )}
    </>
  )
}

export default App
